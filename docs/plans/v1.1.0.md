## Master Eyes v1.1.0 Implementation Plan

### Summary
Add Supabase integration for score submission and leaderboard display. Winning players can submit their name + time to a leaderboard. Main menu gains a Leaderboard option.

### Scope and Success Criteria
- Implement all requirements defined in `/docs/requirements/v1.1.0.md`
- Score submission only available on win
- Leaderboard accessible from main menu
- Snackbar error handling with retry
- Custom styled name input matching theme
- All Supabase config via environment variables

---

### Implementation Architecture

#### 1. Dependencies
- Add `@supabase/supabase-js` to package.json

#### 2. New File Structure

```
src/
├── lib/
│   └── supabase.ts              # Supabase client setup
├── components/
│   ├── main-menu/
│   │   ├── MainMenu.tsx         # Add Leaderboard button
│   │   ├── Leaderboard.tsx      # New: leaderboard display
│   │   └── Snackbar.tsx         # New: error/success notifications
│   └── speed-tiles/
│       └── ResultModal.tsx      # Add name input + submit
└── game/
    ├── reducer.ts               # Add submit actions
    └── types.ts                 # Add submission types
```

---

### 3. Supabase Client (`src/lib/supabase.ts`)

```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

---

### 4. Types Updates (`src/game/types.ts`)

Add to existing types:

```typescript
// Submission types
export interface ScoreSubmission {
  player_name: string;
  board_size: BoardSize;
  completion_time_ms: number;
}

export interface LeaderboardEntry {
  id: string;
  player_name: string;
  board_size: number;
  completion_time_ms: number;
  created_date: string;
}
```

---

### 5. Reducer Updates (`src/game/reducer.ts`)

New actions for result phase:
- `SET_PLAYER_NAME` - Update player name input
- `SUBMIT_SCORE` - Initiate submission
- `SUBMIT_SUCCESS` - Submission completed
- `SUBMIT_ERROR` - Submission failed
- `DISMISS_SNACKBAR` - Clear snackbar state
- `RETRY_SUBMIT` - Retry failed submission

State additions in `ResultState`:
- `playerName: string`
- `isSubmitting: boolean`
- `submitError: string | null`
- `submitSuccess: boolean`

---

### 6. Snackbar Component (`src/components/main-menu/Snackbar.tsx`)

Props:
- `message: string`
- `type: 'error' | 'success'`
- `onRetry?: () => void`
- `onDismiss: () => void`

Features:
- Fixed position at bottom of screen
- Auto-dismiss after 5 seconds (except error)
- Error type shows retry button
- Smooth slide-in/out animation

---

### 7. ResultModal Updates (`src/components/speed-tiles/ResultModal.tsx`)

**When won === true:**
- Add name input field (max 50 chars)
- Add "Submit Score" button
- Add "Skip" button
- Show loading spinner during submission
- Show success/error states

---

### 8. Main Menu Updates (`src/components/main-menu/MainMenu.tsx`)

Add second menu option:
- "Play Game" → Board size selection (existing)
- "Leaderboard" → New leaderboard view

---

### 9. Leaderboard Component (`src/components/main-menu/Leaderboard.tsx`)

Features:
- Fetch top scores from Supabase on mount
- Display as table/list: Rank, Name, Board, Time
- "Back" button to return to menu
- Loading and empty states
- Error state with retry

---

### 10. CSS Updates (`src/styles.css`)

Add:
- `.player-name-input` - Name input styling
- `.snackbar` - Snackbar component styles
- `.snackbar-error` - Error variant
- `.snackbar-success` - Success variant
- `.leaderboard-table` - Leaderboard display styles

---

### 11. Environment Setup

Create `.env.example`:
```
VITE_SUPABASE_URL=your_supabase_project_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

Note: `.env` is already in `.gitignore`, `.env.example` is excluded from gitignore.

---

### 12. SQL Setup (for reference)

```sql
CREATE TABLE IF NOT EXISTS speed_tiles (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  player_name TEXT NOT NULL CHECK (char_length(player_name) <= 50),
  board_size INTEGER NOT NULL CHECK (board_size BETWEEN 3 AND 8),
  completion_time_ms INTEGER NOT NULL CHECK (completion_time_ms > 0),
  created_date TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE speed_tiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Allow anonymous inserts" ON speed_tiles
  FOR INSERT TO anon, authenticated WITH CHECK (true);

CREATE POLICY "Allow public read" ON speed_tiles
  FOR SELECT TO anon, authenticated USING (true);

CREATE INDEX idx_speed_tiles_leaderboard 
ON speed_tiles (board_size, completion_time_ms ASC);
```

---

### Testing Plan

#### Unit Tests
- Player name validation (1-50 chars, trim)
- Reducer submission actions
- Timer formatting for leaderboard display

#### Integration Tests
- Submit flow: win → enter name → submit → success
- Submit flow: win → enter name → submit → error → retry
- Submit flow: win → skip → returns to menu
- Leaderboard: fetches and displays scores
- Leaderboard: shows empty state when no scores
- Leaderboard: error state with retry

---

### Acceptance Scenarios

1. **Win + Submit:**
   - Complete game → win modal → enter name → click Submit → success → returns to menu

2. **Win + Submit + Error:**
   - Complete game → win modal → enter name → click Submit → network error → snackbar appears → click Retry → success

3. **Win + Skip:**
   - Complete game → win modal → click Skip → returns to menu

4. **Lose:**
   - 3 failures → game over modal (no submission option)

5. **Leaderboard:**
   - Main menu → Leaderboard → view top scores → Back → main menu

---

### Delivery Sequence
1. Add @supabase/supabase-js dependency
2. Create supabase client lib
3. Add types and update reducer
4. Create Snackbar component
5. Update ResultModal with name input
6. Create Leaderboard component
7. Update MainMenu with Leaderboard option
8. Add CSS styles
9. Test all flows
10. Verify lint/build
